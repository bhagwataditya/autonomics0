## ---- message = FALSE, warning = FALSE-----------------------------------
library(automax)                # automated analysis of Max Quant proteomics data

## ---- echo = FALSE, message = FALSE, warning = FALSE----------------------------------------------------------------------------------------------------------------------------------------
library(magrittr)                                   # use pipes for convenient scripting
library(xtable)                 # print dataframes to latex
options(xtable.comment = FALSE) # prevent comment creation when producing latex code.
options(width = 190)

## ---- echo = FALSE, results = 'asis'--------------------------------------------------------------------------------------------------------------------------------------------------------
data.frame(experiment = c(1, 2, 3), 
           L          = c('E', 'BM', 'EM'), 
           M          = c('EM', 'E', 'BM'), 
           H          = c('BM', 'EM', 'E')) %>%
xtable(display = c('s', 'd', 's', 's', 's'), align = c('c', 'c', 'c', 'c', 'c')) %>%
print.xtable(include.rownames = FALSE)

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
analysis_dir <- tempdir()
analysis_dir <- gsub('\\', '/', analysis_dir, fixed = TRUE)  # Correct for weird path notation on windows
analysis_dir <- paste0(analysis_dir, '/', 'billing_2016_stem_cell_comparison')
dir.create(analysis_dir)
analysis_dir

## ---- eval = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#  sample_design_file <- paste0(analysis_dir, '/sample_design.txt')
#  create_sample_design_file(
#     infile  = get_billing_experimental_design_template_file(),
#     outfile = sample_design_file
#  )
#   sample_design_file

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
(sample_design_file <- get_billing_sample_design_file())

## ---- echo = FALSE, results = 'asis'--------------------------------------------------------------------------------------------------------------------------------------------------------
read.table(sample_design_file, header = TRUE) %>%
xtable(align = c('c', 'c', 'c', 'c', 'c'))    %>%
print.xtable(include.rownames = FALSE, table.placement = 'H')

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
(protein_groups_file <- get_billing_protein_groups_file())

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
pset <- load_max_quant_table(max_quant_file = protein_groups_file, sample_file = sample_design_file)

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
pset

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(comics.represent)

## ---- eval = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#  exprs(pset)

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
dim(exprs(pset))       # show dimensions of the ratio matrix
dim(pset)              # equivalent!

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
exprs(pset)[1:2, 1:3]  # have a look at the first 2 features and first 3 samples
exprs(pset[1:2, 1:3])  # equivalent!

## ---- eval = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#  intensities_num(pset)   # Get matrix with numerator intensities
#  intensities_den(pset)   # Get matrix with denominator intensities

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
dim(intensities_num(pset))  # numerator   intensities
dim(intensities_den(pset))  # denominator intensities

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
intensities_num(pset)[1:2, 1:3]
intensities_den(pset)[1:2, 1:3]

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fnames(pset)[1:2]  # feature names

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fvars(pset)        # feature variables

## ---- eval = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#  fdata(pset)

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fdata(pset)[1:2, -4]

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
snames(pset)  # sample names

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
svars(pset)   # sample variables

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sdata(pset)   # sample data (rows = samples, columns = sample variables)

## ---- echo = FALSE, results = 'asis'--------------------------------------------------------------------------------------------------------------------------------------------------------
sdata(pset) %>%
xtable() %>%
print.xtable(table.placement = 'H')

## ---- results = 'asis'----------------------------------------------------------------------------------------------------------------------------------------------------------------------
pset <- preprocess_protein_groups(pset, 
                                  rm_na_ratios     = TRUE, 
                                  invert_subgroups = c('E_EM', 'E_BM', 'EM_BM'), 
                                  log2_transform   = TRUE)

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sdata(pset)

## ---- message = FALSE, warning = FALSE------------------------------------------------------------------------------------------------------------------------------------------------------
pset <- analyze_eset(pset, analysis_dir, organism = 'hsa') # 'hsa' = Homo sapiens

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
analysis_dir

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
dir(analysis_dir)

## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
dir(paste0(analysis_dir, '/BM_E'))

## ---- fig.align = 'center', out.width = '4in', echo = FALSE---------------------------------------------------------------------------------------------------------------------------------
   knitr::include_graphics(file.path(analysis_dir, 'sample_distributions_orig.pdf'))

## ---- fig.align = 'center', out.width = '4in', echo = FALSE---------------------------------------------------------------------------------------------------------------------------------
   knitr::include_graphics(file.path(analysis_dir, 'sample_distributions_normalized.pdf'))

## ---- fig.align = 'center', out.width = '4in', echo = FALSE---------------------------------------------------------------------------------------------------------------------------------
   knitr::include_graphics(file.path(analysis_dir, 'pca_samples.pdf'))

## ---- echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   knitr::include_graphics(file.path(analysis_dir, 'BM_E/top_bars__BM_E__neg.pdf'))   

## ---- echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   knitr::include_graphics(file.path(analysis_dir, 'BM_E/top_bars__BM_E__pos.pdf'))   

## ---- echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results <- function(analysis_dir, comparison, direction, collection){
      sprintf('%s/%s/ora_%s_%s.txt', analysis_dir, comparison, direction, collection) %>% 
      comics.support::cfread()                                      %>%
      dplyr::select(-genes)                                         %>% 
      dplyr::mutate(set = substr(set, 1, 50))                       %>% 
      extract(1:10, )                                               %>% 
      xtable(display = c('s', 'd', 'e', 's', 'd', 'd', 'd'))        %>% 
      print.xtable(table.placement = 'H')
   }

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'neg', 'gobp')

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'pos', 'gobp')

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'both', 'gobp')

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'neg', 'gomf')

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'pos', 'gomf')

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'both', 'gomf')

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'neg', 'kegg')

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'pos', 'kegg')

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_E', 'both', 'kegg')

## ---- echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   knitr::include_graphics(file.path(analysis_dir, 'BM_EM/top_bars__BM_EM__neg.pdf'))   

## ---- echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   knitr::include_graphics(file.path(analysis_dir, 'BM_EM/top_bars__BM_EM__pos.pdf'))   

## ---- results = 'asis', echo = FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------
   print_pathway_results(analysis_dir, 'BM_EM', 'neg', 'gobp')

